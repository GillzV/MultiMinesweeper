{% extends "base.html" %}

{% block content %}
<div class="join-game">
    <h2>Join Cooperative Game</h2>
    <div class="form-group">
        <label for="player_name">Your Name:</label>
        <input type="text" id="player_name" class="form-control" required>
    </div>
    <div class="form-group">
        <label for="room_code">Room Code:</label>
        <input type="text" id="room_code" class="form-control" required maxlength="4" pattern="[0-9]{4}">
    </div>
    <button id="join_game">Join Game</button>
    <div id="error" class="error"></div>
</div>

<div id="waiting_area" style="display: none;">
    <h2>Waiting for Game to Start</h2>
    <div id="player_list">
        <h3>Players in Room:</h3>
        <ul id="players"></ul>
    </div>
</div>

<div id="game_area" style="display: none;">
    <h2>Cooperative Minesweeper</h2>
    <div id="shared_grid" class="player-grid"></div>
    <div id="game_over" class="game-over" style="display: none;">
        <h2>Game Over!</h2>
        <button class="new-game-button">New Game</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let socket;
    let roomId;
    let playerName;
    let gridSize;
    let longPressTimer;

    document.addEventListener('DOMContentLoaded', () => {
        socket = io();

        document.getElementById('join_game').addEventListener('click', () => {
            playerName = document.getElementById('player_name').value.trim();
            roomId = document.getElementById('room_code').value.trim();

            if (!playerName) {
                showError('Please enter your name');
                return;
            }

            if (!roomId || !/^\d{4}$/.test(roomId)) {
                showError('Please enter a valid 4-digit room code');
                return;
            }

            socket.emit('join_coop_room', {
                room_id: roomId,
                player_name: playerName
            });
        });

        socket.on('coop_room_joined', (data) => {
            document.querySelector('.join-game').style.display = 'none';
            document.getElementById('waiting_area').style.display = 'block';
            updatePlayerList(data.players);
        });

        socket.on('player_joined_coop', (data) => {
            updatePlayerList(data.players);
        });

        socket.on('player_left_coop', (data) => {
            updatePlayerList(data.players);
        });

        socket.on('coop_game_started', (data) => {
            document.getElementById('waiting_area').style.display = 'none';
            document.getElementById('game_area').style.display = 'block';
            gridSize = data.grid_size;
            createGrid(data.grid, data.mines);
        });

        socket.on('coop_cell_revealed', (data) => {
            const cell = document.querySelector(`[data-row="${data.row}"][data-col="${data.col}"]`);
            if (cell) {
                cell.classList.add('revealed');
                if (data.is_mine) {
                    cell.classList.add('mine');
                    cell.textContent = 'ðŸ’£';
                } else if (data.number > 0) {
                    cell.textContent = data.number;
                    cell.setAttribute('data-number', data.number);
                }
            }
        });

        socket.on('coop_cell_flagged', (data) => {
            const cell = document.querySelector(`[data-row="${data.row}"][data-col="${data.col}"]`);
            if (cell) {
                cell.classList.toggle('flagged');
            }
        });

        socket.on('coop_game_over', () => {
            document.getElementById('game_over').style.display = 'block';
        });

        document.querySelector('.new-game-button').addEventListener('click', () => {
            socket.emit('new_coop_game', { room_id: roomId });
        });

        function updatePlayerList(players) {
            const playerList = document.getElementById('players');
            playerList.innerHTML = '';
            players.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player;
                playerList.appendChild(li);
            });
        }

        function createGrid(grid, mines) {
            const gridContainer = document.getElementById('shared_grid');
            gridContainer.innerHTML = '';
            gridContainer.style.gridTemplateColumns = `repeat(${gridSize}, 30px)`;

            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;

                    // Add event listeners for revealing and flagging cells
                    cell.addEventListener('click', () => {
                        if (!cell.classList.contains('revealed') && !cell.classList.contains('flagged')) {
                            socket.emit('reveal_coop_cell', {
                                room_id: roomId,
                                row: row,
                                col: col
                            });
                        }
                    });

                    cell.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        if (!cell.classList.contains('revealed')) {
                            socket.emit('toggle_coop_flag', {
                                room_id: roomId,
                                row: row,
                                col: col
                            });
                        }
                    });

                    // Long press for flagging on mobile
                    cell.addEventListener('touchstart', () => {
                        longPressTimer = setTimeout(() => {
                            if (!cell.classList.contains('revealed')) {
                                socket.emit('toggle_coop_flag', {
                                    room_id: roomId,
                                    row: row,
                                    col: col
                                });
                            }
                        }, 500);
                    });

                    cell.addEventListener('touchend', () => {
                        clearTimeout(longPressTimer);
                    });

                    gridContainer.appendChild(cell);
                }
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }
    });
</script>
{% endblock %} 