{% extends "base.html" %}

{% block content %}
<div class="game-setup">
    <h2>Create Game</h2>
    <div class="form-group">
        <label for="player_name">Your Name:</label>
        <input type="text" id="player_name" class="form-control" required>
    </div>
    <div class="form-group">
        <label for="grid_size">Grid Size:</label>
        <select id="grid_size" class="form-control">
            <option value="3">3x3</option>
            <option value="4">4x4</option>
            <option value="5">5x5</option>
            <option value="6">6x6</option>
            <option value="7">7x7</option>
            <option value="8">8x8</option>
            <option value="9">9x9</option>
            <option value="10">10x10</option>
            <option value="12">12x12</option>
            <option value="15">15x15</option>
            <option value="20">20x20</option>
        </select>
    </div>
    <div class="form-group">
        <label for="num_mines">Number of Mines:</label>
        <select id="num_mines" class="form-control">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="12">12</option>
            <option value="15">15</option>
            <option value="20">20</option>
        </select>
    </div>
    <button id="create_game">Create Game</button>
    <div id="error" class="error"></div>
</div>

<div id="waiting_area" style="display: none;">
    <h2>Waiting for Players</h2>
    <div class="room-info">
        <h3>Room Code: <span id="room_code"></span></h3>
    </div>
    <div id="player_list">
        <h3>Players in Room:</h3>
        <ul id="players"></ul>
    </div>
    <button id="start_game">Start Game</button>
    <div id="countdown" style="display: none;">
        <h3>Game starting in: <span id="countdown_timer">3</span></h3>
    </div>
</div>

<div id="game_area" style="display: none;">
    <h2>Multiplayer Minesweeper</h2>
    <div id="player_grids"></div>
    <div id="rankings" class="rankings">
        <h3>Rankings</h3>
        <ul id="rankings_list" class="rankings-list"></ul>
    </div>
    <div id="game_over" class="game-over" style="display: none;">
        <h2>Game Over!</h2>
        <button id="new_game">New Game</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let socket;
    let roomId;
    let playerName;
    let longPressTimer;

    document.addEventListener('DOMContentLoaded', () => {
        socket = io();

        document.getElementById('create_game').addEventListener('click', () => {
            playerName = document.getElementById('player_name').value.trim();
            const gridSize = parseInt(document.getElementById('grid_size').value);
            const numMines = parseInt(document.getElementById('num_mines').value);

            if (!playerName) {
                showError('Please enter your name');
                return;
            }

            if (numMines >= gridSize * gridSize) {
                showError('Too many mines for this grid size');
                return;
            }

            roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            socket.emit('create_room', {
                room_id: roomId,
                player_name: playerName,
                grid_size: gridSize,
                num_mines: numMines
            });
        });

        document.getElementById('start_game').addEventListener('click', () => {
            socket.emit('start_game', { room_id: roomId });
        });

        document.getElementById('new_game').addEventListener('click', () => {
            socket.emit('new_game', { room_id: roomId });
        });

        socket.on('room_created', (data) => {
            document.querySelector('.game-setup').style.display = 'none';
            document.getElementById('waiting_area').style.display = 'block';
            document.getElementById('room_code').textContent = roomId;
            updatePlayerList([playerName]);
        });

        socket.on('player_joined', (data) => {
            updatePlayerList(data.players);
        });

        socket.on('player_left', (data) => {
            updatePlayerList(data.players);
        });

        socket.on('game_start', () => {
            document.getElementById('countdown').style.display = 'block';
            let count = 3;
            const countdownElement = document.getElementById('countdown_timer');
            
            const timer = setInterval(() => {
                count--;
                countdownElement.textContent = count;
                
                if (count <= 0) {
                    clearInterval(timer);
                    document.getElementById('waiting_area').style.display = 'none';
                    document.getElementById('game_area').style.display = 'block';
                }
            }, 1000);
        });

        socket.on('game_update', (data) => {
            updateGrids(data.grids);
            updateRankings(data.rankings);
            
            if (data.game_over) {
                document.getElementById('game_over').style.display = 'block';
            }
        });

        function updatePlayerList(players) {
            const playerList = document.getElementById('players');
            playerList.innerHTML = '';
            players.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player;
                playerList.appendChild(li);
            });
        }

        function updateGrids(gridsData) {
            const gridsContainer = document.getElementById('player_grids');
            gridsContainer.innerHTML = '';
            
            Object.entries(gridsData).forEach(([playerId, data]) => {
                const gridDiv = document.createElement('div');
                gridDiv.className = 'player-grid';
                gridDiv.innerHTML = `<h3>${data.name}</h3>`;
                
                const grid = document.createElement('div');
                grid.className = 'grid';
                grid.style.gridTemplateColumns = `repeat(${data.size}, 30px)`;
                
                for (let y = 0; y < data.size; y++) {
                    for (let x = 0; x < data.size; x++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.x = x;
                        cell.dataset.y = y;
                        
                        if (data.visible[y][x]) {
                            cell.classList.add('revealed');
                            if (data.grid[y][x] === -1) {
                                cell.classList.add('mine');
                                cell.textContent = 'ðŸ’£';
                            } else if (data.grid[y][x] > 0) {
                                cell.textContent = data.grid[y][x];
                                cell.setAttribute('data-number', data.grid[y][x]);
                            }
                        }
                        
                        if (data.flagged[y][x]) {
                            cell.classList.add('flagged');
                        }
                        
                        if (playerId === socket.id) {
                            cell.addEventListener('click', () => {
                                if (!cell.classList.contains('revealed') && !cell.classList.contains('flagged')) {
                                    socket.emit('reveal_cell', {
                                        room_id: roomId,
                                        x: x,
                                        y: y
                                    });
                                }
                            });
                            
                            cell.addEventListener('contextmenu', (e) => {
                                e.preventDefault();
                                if (!cell.classList.contains('revealed')) {
                                    socket.emit('toggle_flag', {
                                        room_id: roomId,
                                        x: x,
                                        y: y
                                    });
                                }
                            });
                            
                            // Long press for flagging on mobile
                            cell.addEventListener('touchstart', () => {
                                longPressTimer = setTimeout(() => {
                                    if (!cell.classList.contains('revealed')) {
                                        socket.emit('toggle_flag', {
                                            room_id: roomId,
                                            x: x,
                                            y: y
                                        });
                                    }
                                }, 500);
                            });
                            
                            cell.addEventListener('touchend', () => {
                                clearTimeout(longPressTimer);
                            });
                        }
                        
                        grid.appendChild(cell);
                    }
                }
                
                gridDiv.appendChild(grid);
                gridsContainer.appendChild(gridDiv);
            });
        }

        function updateRankings(rankings) {
            const rankingsList = document.getElementById('rankings_list');
            rankingsList.innerHTML = '';
            
            rankings.forEach((rank, index) => {
                const li = document.createElement('li');
                if (rank.status === 'completed') {
                    li.textContent = `${index + 1}. ${rank.name} - ${rank.time.toFixed(2)}s`;
                } else {
                    li.textContent = `${index + 1}. ${rank.name} - DNF`;
                }
                rankingsList.appendChild(li);
            });
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }
    });
</script>
{% endblock %} 